Fixed as specified, with some heavy rearchitecting of the recent
file code.
