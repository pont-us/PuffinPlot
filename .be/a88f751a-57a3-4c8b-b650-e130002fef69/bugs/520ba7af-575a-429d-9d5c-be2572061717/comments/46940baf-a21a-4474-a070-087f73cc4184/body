Most of the heavy work is done on this now, so I'm going to split
off the remaining bits into separate bugs and close this.
